var De=Object.create;var Q=Object.defineProperty;var xe=Object.getOwnPropertyDescriptor;var ve=Object.getOwnPropertyNames;var we=Object.getPrototypeOf,Se=Object.prototype.hasOwnProperty;var Ae=(u,t)=>()=>(t||u((t={exports:{}}).exports,t),t.exports);var Ce=(u,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of ve(t))!Se.call(u,a)&&a!==e&&Q(u,a,{get:()=>t[a],enumerable:!(n=xe(t,a))||n.enumerable});return u};var Me=(u,t,e)=>(e=u!=null?De(we(u)):{},Ce(t||!u||!u.__esModule?Q(e,"default",{value:u,enumerable:!0}):e,u));var ge=Ae((Pt,ce)=>{"use strict";var le=u=>u&&u.CLOSING===2,Be=()=>typeof WebSocket<"u"&&le(WebSocket),qe=()=>({constructor:Be()?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}),He=(u,t,e)=>{Object.defineProperty(t,e,{get:()=>u[e],set:n=>{u[e]=n},enumerable:!0,configurable:!0})},ie=u=>u.minReconnectionDelay+Math.random()*u.minReconnectionDelay,Ve=(u,t)=>{let e=t*u.reconnectionDelayGrowFactor;return e>u.maxReconnectionDelay?u.maxReconnectionDelay:e},je=["onopen","onclose","onmessage","onerror"],ze=(u,t,e)=>{Object.keys(e).forEach(n=>{e[n].forEach(([a,o])=>{u.addEventListener(n,a,o)})}),t&&je.forEach(n=>{u[n]=t[n]})},ue=function(u,t,e={}){let n,a,o=0,l=0,i=!0,r={};if(!(this instanceof ue))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");let c=qe();if(Object.keys(c).filter(p=>e.hasOwnProperty(p)).forEach(p=>c[p]=e[p]),!le(c.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");let g=c.debug?(...p)=>console.log("RWS:",...p):()=>{},d=(p,y)=>setTimeout(()=>{let b=new Error(y);b.code=p,Array.isArray(r.error)&&r.error.forEach(([U])=>U(b)),n.onerror&&n.onerror(b)},0),s=()=>{if(g("close"),l++,g("retries count:",l),l>c.maxRetries){d("EHOSTDOWN","Too many failed connection attempts");return}o?o=Ve(c,o):o=ie(c),g("reconnectDelay:",o),i&&setTimeout(m,o)},m=()=>{g("connect");let p=n;n=new c.constructor(u,t),a=setTimeout(()=>{g("timeout"),n.close(),d("ETIMEDOUT","Connection timeout")},c.connectionTimeout),g("bypass properties");for(let y in n)["addEventListener","removeEventListener","close","send"].indexOf(y)<0&&He(n,this,y);n.addEventListener("open",()=>{clearTimeout(a),g("open"),o=ie(c),g("reconnectDelay:",o),l=0}),n.addEventListener("close",s),ze(n,p,r)};g("init"),m(),this.close=(p=1e3,y="",{keepClosed:b=!1,fastClose:U=!0,delay:v=0}={})=>{if(v&&(o=v),i=!b,n.close(p,y),U){let D={code:p,reason:y,wasClean:!0};s(),Array.isArray(r.close)&&r.close.forEach(([T,I])=>{T(D),n.removeEventListener("close",T,I)}),n.onclose&&(n.onclose(D),n.onclose=null)}},this.send=p=>{n.send(p)},this.addEventListener=(p,y,b)=>{Array.isArray(r[p])?r[p].some(([U])=>U===y)||r[p].push([y,b]):r[p]=[[y,b]],n.addEventListener(p,y,b)},this.removeEventListener=(p,y,b)=>{Array.isArray(r[p])&&(r[p]=r[p].filter(([U])=>U!==y)),n.removeEventListener(p,y,b)}};ce.exports=ue});var Y=(n=>(n.PRODUCTION="PRODUCTION",n.DEVELOPMENT="DEVELOPMENT",n.TEST="TEST",n))(Y||{}),G=(e=>(e.CLIENT="CLIENT",e.SERVER="SERVER",e))(G||{}),B=(s=>(s.IMAGE_INFERENCE="imageInference",s.IMAGE_UPLOAD="imageUpload",s.IMAGE_UPSCALE="imageUpscale",s.IMAGE_BACKGROUND_REMOVAL="imageBackgroundRemoval",s.IMAGE_CAPTION="imageCaption",s.IMAGE_CONTROL_NET_PRE_PROCESS="imageControlNetPreProcess",s.PROMPT_ENHANCE="promptEnhance",s.AUTHENTICATION="authentication",s.MODEL_UPLOAD="modelUpload",s.PHOTO_MAKER="photoMaker",s.MODEL_SEARCH="modelSearch",s.IMAGE_MASKING="imageMasking",s))(B||{}),Z=(n=>(n.BALANCED="balanced",n.PROMPT="prompt",n.CONTROL_NET="controlnet",n))(Z||{}),$=(s=>(s.canny="canny",s.depth="depth",s.mlsd="mlsd",s.normalbae="normalbae",s.openpose="openpose",s.tile="tile",s.seg="seg",s.lineart="lineart",s.lineart_anime="lineart_anime",s.shuffle="shuffle",s.scribble="scribble",s.softedge="softedge",s))($||{}),X=(f=>(f.canny="canny",f.depth_leres="depth_leres",f.depth_midas="depth_midas",f.depth_zoe="depth_zoe",f.inpaint_global_harmonious="inpaint_global_harmonious",f.lineart_anime="lineart_anime",f.lineart_coarse="lineart_coarse",f.lineart_realistic="lineart_realistic",f.lineart_standard="lineart_standard",f.mlsd="mlsd",f.normal_bae="normal_bae",f.scribble_hed="scribble_hed",f.scribble_pidinet="scribble_pidinet",f.seg_ofade20k="seg_ofade20k",f.seg_ofcoco="seg_ofcoco",f.seg_ufade20k="seg_ufade20k",f.shuffle="shuffle",f.softedge_hed="softedge_hed",f.softedge_hedsafe="softedge_hedsafe",f.softedge_pidinet="softedge_pidinet",f.softedge_pidisafe="softedge_pidisafe",f.tile_gaussian="tile_gaussian",f.openpose="openpose",f.openpose_face="openpose_face",f.openpose_faceonly="openpose_faceonly",f.openpose_full="openpose_full",f.openpose_hand="openpose_hand",f))(X||{}),Oe=(o=>(o.openpose="openpose",o.openpose_face="openpose_face",o.openpose_faceonly="openpose_faceonly",o.openpose_full="openpose_full",o.openpose_hand="openpose_hand",o))(Oe||{}),Ne=(e=>(e.safetensors="safetensors",e.pickletensor="pickletensor",e))(Ne||{}),Le=(m=>(m.flux1d="flux1d",m.flux1s="flux1s",m.pony="pony",m.sdhyper="sdhyper",m.sd1x="sd1x",m.sd1xlcm="sd1xlcm",m.sd3="sd3",m.sdxl="sdxl",m.sdxllcm="sdxllcm",m.sdxldistilled="sdxldistilled",m.sdxlhyper="sdxlhyper",m.sdxllightning="sdxllightning",m.sdxlturbo="sdxlturbo",m))(Le||{}),Ee=(n=>(n.base="base",n.inpainting="inpainting",n.pix2pix="pix2pix",n))(Ee||{}),Ke=(I=>(I.canny="canny",I.depth="depth",I.qrcode="qrcode",I.hed="hed",I.scrible="scrible",I.openpose="openpose",I.seg="segmentation",I.openmlsd="openmlsd",I.softedge="softedge",I.normal="normal bae",I.shuffle="shuffle",I.pix2pix="pix2pix",I.inpaint="inpaint",I.lineart="line art",I.sketch="sketch",I.inpaintdepth="inpaint depth",I.tile="tile",I.outfit="outfit",I.blur="blur",I.gray="gray",I.lowquality="low quality",I))(Ke||{}),Pe=(d=>(d.NoStyle="No style",d.Cinematic="Cinematic",d.DisneyCharacter="Disney Character",d.DigitalArt="Digital Art",d.Photographic="Photographic",d.FantasyArt="Fantasy art",d.Neonpunk="Neonpunk",d.Enhance="Enhance",d.ComicBook="Comic book",d.Lowpoly="Lowpoly",d.LineArt="Line art",d))(Pe||{});import{v4 as We,validate as Fe}from"uuid";var q=6e4,ee=1e3,Ge=100,H={PRODUCTION:"wss://ws-api.runware.ai/v1",TEST:"ws://localhost:8080"},te=(u,t)=>{if(u==null)return;let e=u.indexOf(t);e!==-1&&u.splice(e,1)},x=(u,{debugKey:t="debugKey",timeoutDuration:e=q,shouldThrowError:n=!0})=>(e=e<ee?ee:e,new Promise((a,o)=>{let l=setTimeout(()=>{i&&(clearInterval(i),n&&o(`Response could not be received from server for ${t}`)),clearTimeout(l)},e),i=setInterval(async()=>{u({resolve:a,reject:o,intervalId:i})&&(clearInterval(i),clearTimeout(l))},Ge)})),ne=u=>new Promise(t=>{let e=new FileReader;e.readAsDataURL(u),e.onload=function(){t(e.result)}}),_=()=>We(),se=u=>Fe(u);var re=({key:u,data:t,useZero:e=!0,shouldReturnString:n=!1})=>u.split(/\.|\[/).map(l=>l.replace(/\]$/,"")).reduce((l,i)=>{let r=e?0:void 0,c=l?.[i];if(!c)return r;if(Array.isArray(c)&&/^\d+$/.test(i)){let g=parseInt(i,10);return g>=0&&g<c.length?l[i]=c[g]:l[i]??r}else return l[i]??r},t||{})??{},ae=(u,t=1e3)=>new Promise(e=>setTimeout(e,u*t));var oe=(u,t)=>u.filter(e=>e.key!==t.key);var h=({key:u,value:t})=>t||t===0||t===!1?{[u]:t}:{};var k=async(u,t={})=>{let{delayInSeconds:e=1,callback:n}=t,a=t.maxRetries??1;for(;a;)try{return await u()}catch(o){if(n?.(),a--,a>0)await ae(e),await k(u,{...t,maxRetries:a});else throw o}};var S=class{constructor({apiKey:t,url:e=H.PRODUCTION,shouldReconnect:n=!0,globalMaxRetries:a=2,timeoutDuration:o=q}){this._listeners=[];this._globalMessages={};this._globalImages=[];this.ensureConnectionUUID=null;this.isWebsocketReadyState=()=>this._ws?.readyState===1;this.send=t=>{this._ws.send(JSON.stringify([t]))};this.uploadImage=async t=>{try{return await k(async()=>{let e=_();if(typeof t=="string"&&se(t))return{imageURL:t,imageUUID:t,taskUUID:e,taskType:"imageUpload"};let n=typeof t=="string"?t:await ne(t);return{imageURL:n,imageUUID:n,taskUUID:e,taskType:"imageUpload"}})}catch(e){throw e}};this.controlNetPreProcess=async({inputImage:t,preProcessorType:e,height:n,width:a,outputType:o,outputFormat:l,highThresholdCanny:i,lowThresholdCanny:r,includeHandsAndFaceOpenPose:c,includeCost:g,customTaskUUID:d,retry:s})=>{let m=s||this._globalMaxRetries,p;try{return await k(async()=>{await this.ensureConnection();let y=await this.uploadImage(t);if(!y?.imageUUID)return null;let b=d||_();this.send({inputImage:y.imageUUID,taskType:"imageControlNetPreProcess",taskUUID:b,preProcessorType:e,...h({key:"height",value:n}),...h({key:"width",value:a}),...h({key:"outputType",value:o}),...h({key:"outputFormat",value:l}),...h({key:"includeCost",value:g}),...h({key:"highThresholdCanny",value:i}),...h({key:"lowThresholdCanny",value:r}),...h({key:"includeHandsAndFaceOpenPose",value:c})}),p=this.globalListener({taskUUID:b});let U=await x(({resolve:v,reject:D})=>{let T=this.getSingleMessage({taskUUID:b});if(T){if(T?.error)return D(T),!0;if(T)return v(T),!0}},{debugKey:"unprocessed-image",timeoutDuration:this._timeoutDuration});return p.destroy(),U},{maxRetries:m,callback:()=>{p?.destroy()}})}catch(y){throw y}};this.requestImageToText=async({inputImage:t,includeCost:e,customTaskUUID:n,retry:a})=>{let o=a||this._globalMaxRetries,l;try{return await k(async()=>{await this.ensureConnection();let i=t?await this.uploadImage(t):null,r=n||_();this.send({taskUUID:r,taskType:"imageCaption",inputImage:i?.imageUUID,...h({key:"includeCost",value:e})}),l=this.globalListener({taskUUID:r});let c=await x(({resolve:g,reject:d})=>{let s=this.getSingleMessage({taskUUID:r});if(s){if(s?.error)return d(s),!0;if(s)return delete this._globalMessages[r],g(s),!0}},{debugKey:"remove-image-background",timeoutDuration:this._timeoutDuration});return l.destroy(),c},{maxRetries:o,callback:()=>{l?.destroy()}})}catch(i){throw i}};this.removeImageBackground=async({inputImage:t,outputType:e,outputFormat:n,rgba:a,postProcessMask:o,returnOnlyMask:l,alphaMatting:i,alphaMattingForegroundThreshold:r,alphaMattingBackgroundThreshold:c,alphaMattingErodeSize:g,includeCost:d,customTaskUUID:s,retry:m})=>{let p=m||this._globalMaxRetries,y;try{return await k(async()=>{await this.ensureConnection();let b=t?await this.uploadImage(t):null,U=s||_();this.send({taskType:"imageBackgroundRemoval",taskUUID:U,inputImage:b?.imageUUID,...h({key:"rgba",value:a}),...h({key:"postProcessMask",value:o}),...h({key:"returnOnlyMask",value:l}),...h({key:"alphaMatting",value:i}),...h({key:"includeCost",value:d}),...h({key:"alphaMattingForegroundThreshold",value:r}),...h({key:"alphaMattingBackgroundThreshold",value:c}),...h({key:"alphaMattingErodeSize",value:g}),...h({key:"outputType",value:e}),...h({key:"outputFormat",value:n})}),y=this.globalListener({taskUUID:U});let v=await x(({resolve:D,reject:T})=>{let I=this.getSingleMessage({taskUUID:U});if(I){if(I?.error)return T(I),!0;if(I)return delete this._globalMessages[U],D(I),!0}},{debugKey:"remove-image-background",timeoutDuration:this._timeoutDuration});return y.destroy(),v},{maxRetries:p,callback:()=>{y?.destroy()}})}catch(b){throw b}};this.upscaleGan=async({inputImage:t,upscaleFactor:e,outputType:n,outputFormat:a,includeCost:o,customTaskUUID:l,retry:i})=>{let r=i||this._globalMaxRetries,c;try{return await k(async()=>{await this.ensureConnection();let g;g=await this.uploadImage(t);let d=l||_();this.send({taskUUID:d,inputImage:g?.imageUUID,taskType:"imageUpscale",upscaleFactor:e,...h({key:"includeCost",value:o}),...n?{outputType:n}:{},...a?{outputFormat:a}:{}}),c=this.globalListener({taskUUID:d});let s=await x(({resolve:m,reject:p})=>{let y=this.getSingleMessage({taskUUID:d});if(y){if(y?.error)return p(y),!0;if(y)return delete this._globalMessages[d],m(y),!0}},{debugKey:"upscale-gan",timeoutDuration:this._timeoutDuration});return c.destroy(),s},{maxRetries:r,callback:()=>{c?.destroy()}})}catch(g){throw g}};this.enhancePrompt=async({prompt:t,promptMaxLength:e=380,promptVersions:n=1,includeCost:a,customTaskUUID:o,retry:l})=>{let i=l||this._globalMaxRetries,r;try{return await k(async()=>{await this.ensureConnection();let c=o||_();this.send({prompt:t,taskUUID:c,promptMaxLength:e,promptVersions:n,...h({key:"includeCost",value:a}),taskType:"promptEnhance"}),r=this.globalListener({taskUUID:c});let g=await x(({resolve:d,reject:s})=>{let m=this._globalMessages[c];if(m?.error)return s(m),!0;if(m?.length>=n)return delete this._globalMessages[c],d(m),!0},{debugKey:"enhance-prompt",timeoutDuration:this._timeoutDuration});return r.destroy(),g},{maxRetries:i,callback:()=>{r?.destroy()}})}catch(c){throw c}};this.modelUpload=async t=>{let{onUploadStream:e,retry:n,customTaskUUID:a,...o}=t,l=n||this._globalMaxRetries,i;try{return await k(async()=>{await this.ensureConnection();let r=a||_();this.send({...o,taskUUID:r,taskType:"modelUpload"});let c,g;return i=this.listenToUpload({taskUUID:r,onUploadStream:(s,m)=>{e?.(s,m),s?.status==="ready"?c=s:m&&(g=m)}}),await x(({resolve:s,reject:m})=>{if(c)return s(c),!0;if(g)return m(g),!1},{shouldThrowError:!1,timeoutDuration:60*60*1e3})},{maxRetries:l,callback:()=>{i?.destroy()}})}catch(r){throw r}};this.photoMaker=async t=>{let{onPartialImages:e,retry:n,customTaskUUID:a,numberResults:o,...l}=t,i=n||this._globalMaxRetries,r,c=[],g=0;try{return await k(async()=>{await this.ensureConnection(),g++;let d=this._globalImages.filter(y=>c.includes(y.taskUUID)),s=a||_();c.push(s);let m=o-d.length;this.send({...l,numberResults:m,taskUUID:s,taskType:"photoMaker"}),r=this.listenToImages({onPartialImages:e,taskUUID:s,groupKey:"REQUEST_IMAGES",positivePrompt:l.positivePrompt});let p=await this.getSimilarImages({taskUUID:c,numberResults:o,lis:r});return r.destroy(),p},{maxRetries:i,callback:()=>{r?.destroy()}})}catch(d){if(d.taskUUID)throw d;if(g>=i)return this.handleIncompleteImages({taskUUIDs:c,error:d})}};this.modelSearch=async t=>this.baseSingleRequest({payload:{...t,extra:!0,taskType:"modelSearch"},debugKey:"model-search"});this.imageMasking=async t=>this.baseSingleRequest({payload:{...t,taskType:"imageMasking"},debugKey:"image-masking"});this.baseSingleRequest=async({payload:t,debugKey:e})=>{let{retry:n,customTaskUUID:a,...o}=t,l=n||this._globalMaxRetries,i;try{return await k(async()=>{await this.ensureConnection();let r=a||_();this.send({...o,taskUUID:r}),i=this.globalListener({taskUUID:r});let c=await x(({resolve:g,reject:d})=>{let s=this.getSingleMessage({taskUUID:r});if(s){if(s?.error)return d(s),!0;if(s)return delete this._globalMessages[r],g(s),!0}},{debugKey:e,timeoutDuration:this._timeoutDuration});return i.destroy(),c},{maxRetries:l,callback:()=>{i?.destroy()}})}catch(r){throw r}};this.getSingleMessage=({taskUUID:t})=>{let e=this._globalMessages[t]?.[0],n=this._globalMessages[t];return!e&&!n?null:n?.error?n:e};this.disconnect=async()=>{this._shouldReconnect=!1,this._ws?.terminate?.(),this._ws?.close?.()};this.connected=()=>this.isWebsocketReadyState()&&!!this._connectionSessionUUID;this._apiKey=t,this._url=e,this._sdkType="CLIENT",this._shouldReconnect=n,this._globalMaxRetries=a,this._timeoutDuration=o}static async initialize(t){try{let e=new this(t);return await e.ensureConnection(),e}catch(e){throw e}}addListener({lis:t,groupKey:e,taskUUID:n}){let a=i=>{let r=Array.isArray(i?.data)?i.data:[i.data],c=i?.[0]?.errors?i?.[0]?.errors:Array.isArray(i?.errors)?i.errors:[i.errors],g=r.filter(s=>(s?.taskUUID||s?.taskType)===n);if(c.filter(s=>(s?.taskUUID||s?.taskType)===n).length){t({error:{...c[0]??{}}});return}if(g.length){t({[n]:r});return}},o={key:n||_(),listener:a,groupKey:e};return this._listeners.push(o),{destroy:()=>{this._listeners=oe(this._listeners,o)}}}connect(){this._ws.onopen=t=>{this._connectionSessionUUID?this.send({taskType:"authentication",apiKey:this._apiKey,connectionSessionUUID:this._connectionSessionUUID}):this.send({apiKey:this._apiKey,taskType:"authentication"}),this.addListener({taskUUID:"authentication",lis:e=>{if(e?.error){this._invalidAPIkey=e;return}this._connectionSessionUUID=e?.authentication?.[0]?.connectionSessionUUID,this._invalidAPIkey=void 0}})},this._ws.onmessage=t=>{let e=JSON.parse(t.data);for(let n of this._listeners)if(n?.listener?.(e))return},this._ws.onclose=t=>{this._invalidAPIkey}}destroy(t){te(this._listeners,t)}listenToImages({onPartialImages:t,taskUUID:e,groupKey:n,positivePrompt:a,negativePrompt:o}){return this.addListener({taskUUID:e,lis:l=>{let i=l?.[e]?.filter(r=>r.taskUUID===e);l.error?(t?.(i,l?.error&&l),this._globalError=l):(i=i.map(r=>({...r,positivePrompt:a,negativePrompt:o})),t?.(i,l?.error&&l),this._sdkType==="CLIENT"?this._globalImages=[...this._globalImages,...(l?.[e]??[]).map(r=>({...r,positivePrompt:a,negativePrompt:o}))]:this._globalImages=[...this._globalImages,...i])},groupKey:n})}listenToUpload({onUploadStream:t,taskUUID:e}){return this.addListener({taskUUID:e,lis:n=>{let a=n?.error,o=n?.[e]?.[0],l=o?.taskUUID===e?o:null;(l||a)&&t?.(l||void 0,a)}})}globalListener({taskUUID:t}){return this.addListener({taskUUID:t,lis:e=>{if(e.error){this._globalMessages[t]=e;return}let n=re({key:t,data:e,useZero:!1});Array.isArray(n)?n.forEach(a=>{this._globalMessages[a.taskUUID]=[...this._globalMessages[a.taskUUID]??[],a]}):this._globalMessages[n.taskUUID]=n}})}async requestImages({outputType:t,outputFormat:e,uploadEndpoint:n,checkNSFW:a,positivePrompt:o,negativePrompt:l,seedImage:i,maskImage:r,strength:c,height:g,width:d,model:s,steps:m,scheduler:p,seed:y,CFGScale:b,clipSkip:U,usePromptWeighting:v,promptWeighting:D,numberResults:T=1,controlNet:I,lora:V,onPartialImages:me,includeCost:ye,customTaskUUID:Ie,retry:he,refiner:f,maskMargin:fe},be){let A,j,M=[],z=0,J=he||this._globalMaxRetries;try{await this.ensureConnection();let w=null,E=null,K=[];if(i){let R=await this.uploadImage(i);if(!R)return[];w=R.imageUUID}if(r){let R=await this.uploadImage(r);if(!R)return[];E=R.imageUUID}if(I?.length)for(let R=0;R<I.length;R++){let C=I[R],{endStep:P,startStep:W,weight:F,guideImage:O,controlMode:Ue,startStepPercentage:Te,endStepPercentage:_e,model:ke}=C,Re=O?await this.uploadImage(O):null;K.push({guideImage:Re?.imageUUID,model:ke,endStep:P,startStep:W,weight:F,...h({key:"startStepPercentage",value:Te}),...h({key:"endStepPercentage",value:_e}),controlMode:Ue||"controlnet"})}return j={taskType:"imageInference",model:s,positivePrompt:o,...l?{negativePrompt:l}:{},...g?{height:g}:{},...d?{width:d}:{},numberResults:T,...V?.length?{lora:V}:{},...t?{outputType:t}:{},...e?{outputFormat:e}:{},...n?{uploadEndpoint:n}:{},...h({key:"checkNSFW",value:a}),...h({key:"strength",value:c}),...h({key:"CFGScale",value:b}),...h({key:"clipSkip",value:U}),...h({key:"maskMargin",value:fe}),...h({key:"usePromptWeighting",value:v}),...h({key:"steps",value:m}),...D?{promptWeighting:D}:{},...K.length?{controlNet:K}:{},...y?{seed:y}:{},...p?{scheduler:p}:{},...f?{refiner:f}:{},...h({key:"includeCost",value:ye}),...w?{seedImage:w}:{},...E?{maskImage:E}:{},...be??{}},await k(async()=>{z++,A?.destroy();let R=this._globalImages.filter(O=>M.includes(O.taskUUID)),C=Ie||_();M.push(C);let P=T-R.length,W={...j,taskUUID:C,numberResults:P};this.send(W),A=this.listenToImages({onPartialImages:me,taskUUID:C,groupKey:"REQUEST_IMAGES",positivePrompt:o,negativePrompt:l});let F=await this.getSimilarImages({taskUUID:M,numberResults:T,lis:A});return A.destroy(),F},{maxRetries:J,callback:()=>{A?.destroy()}})}catch(w){if(z>=J)return this.handleIncompleteImages({taskUUIDs:M,error:w});throw w}}async ensureConnection(){if(this.connected()||this._url===H.TEST)return;let e=2e3,n=200;try{if(this._invalidAPIkey)throw this._invalidAPIkey;return new Promise((a,o)=>{let l=0,i=30,r=_(),c,g,d=()=>{this.ensureConnectionUUID=null,clearInterval(c),clearInterval(g)};this._sdkType==="SERVER"&&(c=setInterval(async()=>{try{let s=this.connected(),m=!1;(!this.ensureConnectionUUID||r===this.ensureConnectionUUID)&&(this.ensureConnectionUUID||(this.ensureConnectionUUID=r),m=!0);let p=l%10===0&&m;s?(d(),a(!0)):l>=i?(d(),o(new Error("Retry timed out"))):(p&&this.connect(),l++)}catch(s){d(),o(s)}},e)),g=setInterval(async()=>{if(this.connected()){d(),a(!0);return}if(this._invalidAPIkey){d(),o(this._invalidAPIkey);return}},n)})}catch{throw this.ensureConnectionUUID=null,this._invalidAPIkey??"Could not connect to server. Ensure your API key is correct"}}async getSimilarImages({taskUUID:t,numberResults:e,shouldThrowError:n,lis:a}){return await x(({resolve:o,reject:l,intervalId:i})=>{let r=Array.isArray(t)?t:[t],c=this._globalImages.filter(g=>r.includes(g.taskUUID));if(this._globalError){let g=this._globalError;return this._globalError=void 0,clearInterval(i),l?.(g),!0}else if(c.length>=e)return clearInterval(i),this._globalImages=this._globalImages.filter(g=>!r.includes(g.taskUUID)),o([...c].slice(0,e)),!0},{debugKey:"getting images",shouldThrowError:n,timeoutDuration:this._timeoutDuration})}handleIncompleteImages({taskUUIDs:t,error:e}){let n=this._globalImages.filter(a=>t.includes(a.taskUUID));if(n.length>1)return this._globalImages=this._globalImages.filter(a=>!t.includes(a.taskUUID)),n;throw e}};var de=Me(ge(),1),N=class extends S{constructor(t){let{shouldReconnect:e,...n}=t;super(n),this._ws=new de.default(this._url),this.connect()}};import Je from"ws";var L=class extends S{constructor(e){super(e);this._instantiated=!1;this._listeners=[];this._reconnectingIntervalId=null;this.send=e=>{this._ws.send(JSON.stringify([e]))};this.resetConnection=()=>{this._ws&&(this._listeners.forEach(e=>{e?.destroy?.()}),this._ws.removeAllListeners(),this._ws.readyState===1&&(this._ws.terminate(),this._ws.close()),this._ws=null,this._listeners=[])};this._sdkType="SERVER",this.connect()}async connect(){this._url&&(this.resetConnection(),this._ws=new Je(this._url,{perMessageDeflate:!1}),this._ws.on("error",()=>{}),this._ws.on("close",()=>{this.handleClose()}),this._ws.on("open",()=>{this._reconnectingIntervalId&&clearInterval(this._reconnectingIntervalId),this._connectionSessionUUID&&this.isWebsocketReadyState()?this.send({taskType:"authentication",apiKey:this._apiKey,connectionSessionUUID:this._connectionSessionUUID}):this.isWebsocketReadyState()&&this.send({apiKey:this._apiKey,taskType:"authentication"}),this.addListener({taskUUID:"authentication",lis:e=>{if(e?.error){this._invalidAPIkey=e;return}this._connectionSessionUUID=e?.authentication?.[0]?.connectionSessionUUID,this._invalidAPIkey=void 0}})}),this._ws.on("message",(e,n)=>{let a=n?e:e?.toString();if(!a)return;let o=JSON.parse(a);this._listeners.forEach(l=>{l.listener(o)})}))}handleClose(){this._invalidAPIkey||(this._reconnectingIntervalId&&clearInterval(this._reconnectingIntervalId),this._shouldReconnect&&setTimeout(()=>this.connect(),1e3))}heartBeat(){clearTimeout(this._pingTimeout),this._pingTimeout=setTimeout(()=>{this.isWebsocketReadyState()&&this.send({ping:!0})},5e3)}};var pe;typeof window>"u"?pe=L:pe=N;export{Z as EControlMode,Le as EModelArchitecture,Ke as EModelConditioning,Ne as EModelFormat,Ee as EModelType,Oe as EOpenPosePreProcessor,Pe as EPhotoMakerEnum,X as EPreProcessor,$ as EPreProcessorGroup,B as ETaskType,Y as Environment,pe as Runware,N as RunwareClient,L as RunwareServer,G as SdkType};
//# sourceMappingURL=index.js.map